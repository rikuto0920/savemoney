<div class="container mypage">
  <!-- プロフィールヘッダー -->
  <section class="profile-card">
    <div class="avatar">
      <% if @user.prof? %>
        <%= image_tag @user.prof_url, alt: @user.name %>
      <% else %>
        <span><%= (@user.name.presence || @user.email).to_s.first&.upcase %></span>
      <% end %>
    </div>

    <div class="info">
      <h1 class="nickname"><%= @user.name.presence || "名無し" %></h1>
      <div class="meta">
        <span class="email"><%= @user.email %></span>
      </div>
      <% if @user.profile.present? %>
        <p class="profile-text"><%= @user.profile %></p>
      <% end %>

      <div class="actions">
        <% if current_user == @user %>
          <%= link_to "プロフィール編集", edit_user_registration_path, class: "btn btn-ghost" %>
        <% end %>
        <%= link_to "ホームに戻る", students_path, class: "back-to-list" %>
      </div>
    </div>

    <ul class="stats">
      <li><span><%= @user.students.count %></span>出品</li>
      <li><span><%= @user.likes.count %></span>いいね</li>
    </ul>
  </section>

  <!-- 相手ユーザーを見ているときだけDM導線を表示 -->
  <% if current_user != @user %>
    <section class="dm-card">
      <% if @isRoom %>
        <%= link_to "DMへ", room_path(@roomId), class: "btn btn-primary" %>
      <% else %>
        <%= form_for @room, html: { class: "dm-form" } do |f| %>
          <%= fields_for @entry do |e| %>
            <%= e.hidden_field :user_id, value: @user.id %>
          <% end %>
          <%= f.submit "DMを開始する", class: "btn btn-primary" %>
        <% end %>
      <% end %>
    </section>
  <% else %>
    <%# 自分のページの時のメッセージ（任意） %>
    <% if defined?(@msg) && @msg.present? %>
      <section class="dm-card muted"><%= @msg %></section>
    <% end %>
  <% end %>

  <!-- 出品一覧 -->
  <section class="section">
    <h2 class="section-title">出品一覧</h2>
    <% if @user.students.any? %>
      <div class="cards">
        <% @user.students.each do |t| %>
          <div class="card">
            <%= link_to student_path(t) do %>
              <% if t.image? %><img src="<%= t.image_url %>" alt="<%= t.name %>"><% end %>
              <div class="card-body">
                <% if t.daigaku.present? %><span class="badge"><%= t.daigaku %></span><% end %>
                <h3 class="title"><%= t.name %></h3>
                <p class="muted"><%= t.created_at.strftime("%Y-%m-%d") %></p>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="empty">まだ出品がありません。</p>
    <% end %>
  </section>
</div>
